<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>S.I.G. Agro-Clim√°tico AEMET Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f1f5f9; color: #1e293b; }
        .container { max-width: 1100px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header-step { border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 20px; color: #1e3a8a; font-weight: bold; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-blue { background: #2563eb; color: white; }
        .btn-green { background: #16a34a; color: white; width: 100%; margin-top: 15px; font-size: 1.1em; }
        input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .result-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 15px; }
        .chart-header { text-align: center; margin-bottom: 10px; color: #1e40af; font-size: 1.3em; font-weight: bold; }
        .chart-container { height: 480px; margin-bottom: 30px; padding-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 0.85em; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: right; }
        th { background: #f1f5f9; text-align: left; color: #475569; }
        td:first-child { text-align: left; font-weight: bold; }
        .fila-total { background-color: #fef3c7; font-weight: bold; color: #92400e; }
        .fila-media { background-color: #dcfce7; font-weight: bold; color: #166534; }
        .grid-tablas { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 768px) { .grid-tablas { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header-step">üìç 1. Localizaci√≥n de Parcela</div>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            Lat: <input type="number" id="userLat" value="39.443557" step="0.000001">
            Lon: <input type="number" id="userLon" value="-0.740434" step="0.000001">
            <button class="btn btn-blue" onclick="encontrarMasCercana()">Buscar Estaci√≥n</button>
        </div>
        <div id="resBusqueda" class="result-box" style="display:none"></div>
    </div>

    <div class="card">
        <div class="header-step">üìä 2. Informe Climatol√≥gico Mensual</div>
        <p>Sube el archivo <code>datos_historicos.json</code> obtenido de Postman:</p>
        <input type="file" id="fileDatos" accept=".json">
        
        <div id="panelAnalisis" style="display:none">
            <div id="tituloPeriodo" class="chart-header"></div>
            
            <div class="chart-container">
                <canvas id="graficaLluvia"></canvas>
            </div>

            <button id="btnExcel" class="btn btn-green">üì• Descargar Informe Completo (Formato .xlsx)</button>

            <div class="grid-tablas">
                <div>
                    <h4 style="color:#166534; border-bottom: 2px solid #bbf7d0;">üìà Resumen Medias (mm)</h4>
                    <table>
                        <thead><tr><th>Mes</th><th>Media (mm)</th></tr></thead>
                        <tbody id="cuerpoMedias"></tbody>
                    </table>
                </div>
                <div>
                    <h4 style="color:#1e40af; border-bottom: 2px solid #bfdbfe;">üìÖ Historial Detallado</h4>
                    <table>
                        <thead><tr><th>A√±o-Mes</th><th>Lluvia (mm)</th></tr></thead>
                        <tbody id="cuerpoTabla"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
const formatReg = { minimumFractionDigits: 1, maximumFractionDigits: 1 };
const mesesNombres = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

function aemetToDec(coord) {
    if(!coord) return 0;
    const dir = coord.slice(-1), n = coord.slice(0, -1);
    const s = parseFloat(n.slice(-2)), m = parseFloat(n.slice(-4, -2)), g = parseFloat(n.slice(0, n.length - 4));
    let dec = g + (m/60) + (s/3600);
    return (dir === 'S' || dir === 'W') ? -dec : dec;
}

function encontrarMasCercana() {
    fetch('estaciones.json').then(r => r.json()).then(ests => {
        const latU = parseFloat(document.getElementById('userLat').value);
        const lonU = parseFloat(document.getElementById('userLon').value);
        let mejor = null, dMin = Infinity;
        ests.forEach(e => {
            const d = Math.sqrt(Math.pow(latU - aemetToDec(e.latitud), 2) + Math.pow(lonU - aemetToDec(e.longitud), 2));
            if(d < dMin) { dMin = d; mejor = e; }
        });
        const res = document.getElementById('resBusqueda');
        res.style.display = "block";
        res.innerHTML = `<strong>‚úÖ Estaci√≥n:</strong> ${mejor.nombre} | <strong>Referencia:</strong> ${(dMin*111).toLocaleString('es-ES', formatReg)} km`;
    });
}

let miGrafica = null;
let exportData = [];

document.getElementById('fileDatos').addEventListener('change', function(e) {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const raw = JSON.parse(ev.target.result);
        
        let proc = raw.map(d => {
            const p = d.fecha.split('-');
            return { anio: parseInt(p[0]), mes: parseInt(p[1]), fOriginal: d.fecha, valor: parseFloat(String(d.p_mes || d.prec || "0").replace(',', '.')) || 0 };
        }).sort((a, b) => a.anio !== b.anio ? a.anio - b.anio : a.mes - b.mes);

        const mesesReales = proc.filter(d => d.mes !== 13);
        const anioIni = mesesReales[0].anio;
        const anioFin = mesesReales[mesesReales.length - 1].anio;
        document.getElementById('tituloPeriodo').innerText = `Media de Precipitaci√≥n Mensual (mm) ‚Ä¢ Periodo ${anioIni} - ${anioFin}`;

        const cuerpo = document.getElementById('cuerpoTabla');
        const cuerpoMed = document.getElementById('cuerpoMedias');
        cuerpo.innerHTML = ""; cuerpoMed.innerHTML = "";
        
        const stats = Array(13).fill(0).map(() => ({ sum: 0, count: 0 }));
        exportData = [];

        proc.forEach(d => {
            const vStr = d.valor.toLocaleString('es-ES', formatReg);
            if (d.mes === 13) {
                cuerpo.innerHTML += `<tr class="fila-total"><td>TOTAL ANUAL ${d.anio}</td><td>${vStr} mm</td></tr>`;
                exportData.push({ "Periodo": `TOTAL ${d.anio}`, "Precipitaci√≥n (mm)": vStr });
            } else {
                cuerpo.innerHTML += `<tr><td>${d.fOriginal}</td><td>${vStr} mm</td></tr>`;
                exportData.push({ "Periodo": d.fOriginal, "Precipitaci√≥n (mm)": vStr });
                stats[d.mes].sum += d.valor; stats[d.mes].count++;
            }
        });

        const mediasFinales = [];
        exportData.push({ "Periodo": "--- RESUMEN MEDIAS ---", "Precipitaci√≥n (mm)": "" });
        for (let i = 1; i <= 12; i++) {
            const mVal = stats[i].count > 0 ? stats[i].sum / stats[i].count : 0;
            mediasFinales.push(mVal);
            const mStr = mVal.toLocaleString('es-ES', formatReg);
            cuerpoMed.innerHTML += `<tr class="fila-media"><td>${mesesNombres[i-1]}</td><td>${mStr} mm</td></tr>`;
            exportData.push({ "Periodo": `Media ${mesesNombres[i-1]}`, "Precipitaci√≥n (mm)": mStr });
        }

        document.getElementById('panelAnalisis').style.display = "block";
        const ctx = document.getElementById('graficaLluvia').getContext('2d');
        if(miGrafica) miGrafica.destroy();
        
        miGrafica = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: mesesNombres, 
                datasets: [{ 
                    data: mediasFinales, 
                    backgroundColor: '#16a34a',
                    borderRadius: 6 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end', align: 'top',
                        formatter: (val) => val.toLocaleString('es-ES', formatReg) + ' mm',
                        font: { weight: 'bold', size: 11 }, color: '#1e3a8a'
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        suggestedMax: Math.max(...mediasFinales) * 1.2,
                        title: { display: true, text: 'Precipitaci√≥n (mm)', font: { weight: 'bold' } },
                        ticks: { callback: v => v.toLocaleString('es-ES', formatReg) } 
                    } 
                }
            }
        });
    };
    reader.readAsText(e.target.files[0]);
});

document.getElementById('btnExcel').addEventListener('click', () => {
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Informe");
    XLSX.writeFile(wb, "Informe_Precipitacion_AEMET.xlsx");
});
</script>
</body>
</html>
