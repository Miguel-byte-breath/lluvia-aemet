<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>S.I.G. Agro-Clim√°tico AEMET Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f1f5f9; color: #1e293b; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header-step { border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 20px; color: #1e3a8a; font-weight: bold; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-blue { background: #2563eb; color: white; }
        .btn-green { background: #16a34a; color: white; width: 100%; margin-top: 15px; }
        .btn:hover { opacity: 0.9; }
        input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .result-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 15px; }
        .chart-container { height: 400px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: right; }
        th { background: #f1f5f9; text-align: left; }
        td:first-child { text-align: left; font-weight: bold; }
        .fila-total { background-color: #fef3c7; font-weight: bold; color: #92400e; }
        .fila-media { background-color: #dcfce7; font-weight: bold; color: #166534; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 600px) { .summary-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header-step">üìç 1. Localizaci√≥n de Estaci√≥n</div>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            Lat: <input type="number" id="userLat" value="39.443557" step="0.000001">
            Lon: <input type="number" id="userLon" value="-0.740434" step="0.000001">
            <button class="btn btn-blue" onclick="encontrarMasCercana()">Buscar Estaci√≥n</button>
        </div>
        <div id="resBusqueda" class="result-box" style="display:none"></div>
    </div>

    <div class="card">
        <div class="header-step">üìä 2. An√°lisis Estad√≠stico Hist√≥rico</div>
        <p>Carga el JSON con varios a√±os de datos:</p>
        <input type="file" id="fileDatos" accept=".json">
        
        <div id="panelAnalisis" style="display:none">
            <button id="btnExcel" class="btn btn-green">üì• Exportar Informe Completo (con Medias) a Excel</button>
            
            <div class="chart-container">
                <canvas id="graficaLluvia"></canvas>
            </div>

            <div class="summary-grid">
                <div>
                    <h4 style="color:#1e3a8a">üìÖ Hist√≥rico de Precipitaciones</h4>
                    <table id="tablaHistorica">
                        <thead><tr><th>Periodo</th><th>Lluvia (mm)</th></tr></thead>
                        <tbody id="cuerpoTabla"></tbody>
                    </table>
                </div>
                <div>
                    <h4 style="color:#166534">üìà Medias Mensuales (del periodo)</h4>
                    <table id="tablaMedias">
                        <thead><tr><th>Mes</th><th>Media (mm)</th></tr></thead>
                        <tbody id="cuerpoMedias"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- BUSCADOR ---
function aemetToDec(coord) {
    if(!coord) return 0;
    const dir = coord.slice(-1), n = coord.slice(0, -1);
    const s = parseFloat(n.slice(-2)), m = parseFloat(n.slice(-4, -2)), g = parseFloat(n.slice(0, n.length - 4));
    let dec = g + (m/60) + (s/3600);
    return (dir === 'S' || dir === 'W') ? -dec : dec;
}

function encontrarMasCercana() {
    fetch('estaciones.json').then(r => r.json()).then(ests => {
        const latU = parseFloat(document.getElementById('userLat').value);
        const lonU = parseFloat(document.getElementById('userLon').value);
        let mejor = null, dMin = Infinity;
        ests.forEach(e => {
            const d = Math.sqrt(Math.pow(latU - aemetToDec(e.latitud), 2) + Math.pow(lonU - aemetToDec(e.longitud), 2));
            if(d < dMin) { dMin = d; mejor = e; }
        });
        const res = document.getElementById('resBusqueda');
        res.style.display = "block";
        res.innerHTML = `<strong>‚úÖ Estaci√≥n:</strong> ${mejor.nombre} | <strong>C√≥digo:</strong> <span style="color:red">${mejor.indicativo}</span>`;
    });
}

// --- PROCESADOR MATEM√ÅTICO ---
let miGrafica = null;
let datosParaExcel = [];
const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

document.getElementById('fileDatos').addEventListener('change', function(e) {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const datosJSON = JSON.parse(ev.target.result);
        
        let datosProcesados = datosJSON.map(d => {
            const partes = d.fecha.split('-');
            return {
                anio: parseInt(partes[0]),
                mes: parseInt(partes[1]),
                fechaOriginal: d.fecha,
                valor: parseFloat(String(d.p_mes || d.prec || "0").replace(',', '.')) || 0
            };
        }).sort((a, b) => (a.anio !== b.anio) ? a.anio - b.anio : a.mes - b.mes);

        const cuerpo = document.getElementById('cuerpoTabla');
        const cuerpoMedias = document.getElementById('cuerpoMedias');
        cuerpo.innerHTML = "";
        cuerpoMedias.innerHTML = "";
        
        const labelsGraf = [];
        const valuesGraf = [];
        const acumMedias = Array(13).fill(0).map(() => ({ sum: 0, count: 0 }));
        datosParaExcel = [];

        // 1. Procesar Historial
        datosProcesados.forEach(d => {
            const valorStr = d.valor.toLocaleString('es-ES', {minimumFractionDigits: 1});
            
            if (d.mes === 13) {
                cuerpo.innerHTML += `<tr class="fila-total"><td>TOTAL ${d.anio}</td><td>${valorStr} mm</td></tr>`;
                datosParaExcel.push({ "Periodo": `TOTAL ${d.anio}`, "Precipitaci√≥n (mm)": valorStr });
            } else {
                labelsGraf.push(d.fechaOriginal);
                valuesGraf.push(d.valor);
                cuerpo.innerHTML += `<tr><td>${d.fechaOriginal}</td><td>${valorStr} mm</td></tr>`;
                datosParaExcel.push({ "Periodo": d.fechaOriginal, "Precipitaci√≥n (mm)": valorStr });
                
                // Acumular para medias
                acumMedias[d.mes].sum += d.valor;
                acumMedias[d.mes].count += 1;
            }
        });

        // 2. Procesar Medias Mensuales
        datosParaExcel.push({ "Periodo": "--- MEDIAS MENSUALES ---", "Precipitaci√≥n (mm)": "" });
        for (let i = 1; i <= 12; i++) {
            if (acumMedias[i].count > 0) {
                const media = acumMedias[i].sum / acumMedias[i].count;
                const mediaStr = media.toLocaleString('es-ES', {minimumFractionDigits: 1});
                cuerpoMedias.innerHTML += `<tr class="fila-media"><td>${nombresMeses[i-1]}</td><td>${mediaStr} mm</td></tr>`;
                datosParaExcel.push({ "Periodo": `MEDIA ${nombresMeses[i-1]}`, "Precipitaci√≥n (mm)": mediaStr });
            }
        }

        document.getElementById('panelAnalisis').style.display = "block";

        // 3. Gr√°fica
        const ctx = document.getElementById('graficaLluvia').getContext('2d');
        if(miGrafica) miGrafica.destroy();
        miGrafica = new Chart(ctx, {
            type: 'bar',
            data: { labels: labelsGraf, datasets: [{ label: 'Lluvia Mensual (mm)', data: valuesGraf, backgroundColor: '#3b82f6' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    };
    reader.readAsText(e.target.files[0]);
});

document.getElementById('btnExcel').addEventListener('click', () => {
    const ws = XLSX.utils.json_to_sheet(datosParaExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Estad√≠sticas");
    XLSX.writeFile(wb, "Informe_Agro_Estadistico.xlsx");
});
</script>
</body>
</html>
