<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Herramienta Agro-Clim谩tica AEMET</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f1f5f9; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 3px solid #10b981; padding-bottom: 20px; margin-bottom: 20px; }
        .upload-area { background: #ecfdf5; border: 2px dashed #10b981; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .btn-excel { background: #059669; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: none; margin: 10px auto; }
        .btn-excel:hover { background: #047857; }
        #info-estacion { font-weight: bold; color: #065f46; margin-top: 10px; }
        .chart-box { height: 400px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analizador de Datos AEMET</h1>
            <p>Carga el JSON de Postman para procesar la informaci贸n</p>
        </div>

        <div class="upload-area">
            <input type="file" id="inputJson" accept=".json">
            <div id="info-estacion"></div>
        </div>

        <div style="text-align: center;">
            <button id="btnExportar" class="btn-excel"> Descargar Resumen en Excel</button>
        </div>

        <div class="chart-box">
            <canvas id="graficaLluvia"></canvas>
        </div>
    </div>

    <script>
        let datosProcesados = []; // Guardaremos los datos para el Excel
        let miGrafica = null;

        document.getElementById('inputJson').addEventListener('change', function(e) {
            const archivo = e.target.files[0];
            if (!archivo) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const datos = JSON.parse(e.target.result);
                    procesarDatos(datos);
                } catch (error) {
                    alert("Error: El archivo no es un JSON v谩lido.");
                }
            };
            reader.readAsText(archivo);
        });

        function procesarDatos(datos) {
            if (!datos.length) return;

            // Info de la estaci贸n
            document.getElementById('info-estacion').innerText = `Estaci贸n: ${datos[0].nombre} (${datos[0].indicativo})`;
            document.getElementById('btnExportar').style.display = 'block';

            const resumen = {};
            datos.forEach(d => {
                if (d.fecha && d.prec) {
                    const mes = d.fecha.substring(0, 7);
                    const lluvia = parseFloat(d.prec.replace(',', '.')) || 0;
                    resumen[mes] = (resumen[mes] || 0) + lluvia;
                }
            });

            const etiquetas = Object.keys(resumen).sort();
            const valores = etiquetas.map(m => resumen[m]);

            // Guardamos para el Excel
            datosProcesados = etiquetas.map(m => ({ "Mes": m, "Lluvia Total (mm)": resumen[m].toFixed(1) }));

            dibujarGrafica(etiquetas, valores);
        }

        function dibujarGrafica(labels, values) {
            const ctx = document.getElementById('graficaLluvia').getContext('2d');
            
            if (miGrafica) miGrafica.destroy(); // Borra la gr谩fica anterior si existe

            miGrafica = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Precipitaci贸n Acumulada (mm)',
                        data: values,
                        backgroundColor: '#10b981'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        document.getElementById('btnExportar').addEventListener('click', function() {
            const ws = XLSX.utils.json_to_sheet(datosProcesados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Resumen Lluvia");
            XLSX.writeFile(wb, "Resumen_AEMET_Mensual.xlsx");
        });
    </script>
</body>
</html>
